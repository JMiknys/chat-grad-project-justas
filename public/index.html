<!DOCTYPE html>
<html lang="en" ng-app="ChatApp">
    <head>
        <meta charset="utf-8">
        <title>Chat</title>
        <link href="main.css" rel="stylesheet" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.1/angular.min.js"></script>
        <script src="http://localhost:9999/socket.io/socket.io.js "></script>
    </head>
    <body ng-controller="ChatController as ctrl">
        <a ng-show="!loggedIn" href="{{loginUri}}">Log in</a>
        <section ng-show="loggedIn">
            <p>Logged in as {{user.name}}.</p>
            <h2 ng-show="false">List of registered users</h2>
            <ul ng-show="false">
                <li ng-repeat="user in users">
                    Name: {{user.name}}
                    <br/>
                    Image: <img height="42" width="42" ng-src="{{user.avatarUrl}}">
                    <br/>
                    ID: {{user.id}}
                </li>
            </ul>
            <h2>Start a new conversation</h2>
            <span>Topic</span><br/>
            <input type="text" name="input" ng-model="title" required> <br/>
            <select ng-model="selectedUser" ng-options="user.id as user.name for user in users">
                <option value="">Select User</option>
            </select>
            <button ng-click="ctrl.addToChat()">Add to conversation</button>
            <ul>
                <li ng-repeat="user in chat">
                    Name: {{user.name}}
                    <button>Remove</button>
                </li>
            </ul>
            <button ng-show="chat.length > 0" ng-click="ctrl.startChat()">Start a conversation</button>
            <div>
              <h3>Conversations</h3>
              <button ng-click="ctrl.getConversations()">Show my conversations</button>
              <!--
              <div ng-repeat="conversation in conversations">
                <h4>Conversation Topic: {{conversation.title}}</h4>
                <h5>Participants:</h5>
                  <span ng-repeat="participant in conversation.participants">{{participant}}</span>
                <h5>Messages:</h5>
                  <ul>
                      <li ng-repeat="message in conversation.messages">
                          From: {{message.sender}} <br/>
                          Body: {{message.body}}  <br/>
                          Time: {{message.time | date:"MM/dd/yyyy 'at' h:mma"}}
                      </li>
                  </ul>
                  <input ng-model="newMessage" placeholder="Enter your message" type="text" name="input"> <br/>
                  <button ng-click="ctrl.sendMessage(conversation._id, newMessage)">Send message</button>
              </div>
            -->
            <div class="wrapper" ng-repeat="conversation in conversations">
              <div class="chat-metadata">
                <span>Topic: {{conversation.title}}</span>
                <span>Participants: {{conversation.participants.length}}</span>
                <button ng-click="ctrl.leaveConversation(conversation._id)">Leave conversation</button>
              </div>
              <div class="chat-container">
                  <div class="left-container">
                      <div class="messages-container" id="{{conversation._id}}-messages">
                        <ul class="no-style-ul messages-list">
                          <li ng-repeat="message in conversation.messages">
                            <span style="font-style:italic;">{{message.time | date:"dd/MM h:mma"}}</span>
                            <span style="font-weight:bold;">{{message.sender}}: </span>
                            <p>{{message.body}}</p>
                          </li>
                        </ul>
                      </div>
                      <div class="inputbox-container">
                          <input id="{{conversation._id}}-input" ng-model="newMessage" placeholder="Enter your message" type="text" name="input">
                      </div>
                  </div>
                  <div class="right-container">
                    <div class="participants-container">
                      <ul class="no-style-ul participants-list">
                        <li ng-repeat="user in conversation.participants">
                        <img ng-show="!ctrl.isOnline(user.id)" src="images/red_circle.jpg"></img>
                        <img ng-show="ctrl.isOnline(user.id)" src="images/circle_green.png"></img>
                        {{user.id}}</li>
                      </ul>
                    </div>
                    <div class="send-container">
                      <button ng-click="ctrl.sendMessage(conversation._id, newMessage)">Send</button>
                    </div>
                  </div>
              </div>
            </div>
            <button ng-click="ctrl.showOnline()">Check online users</button>

        </section>
        <script src="js/main.js"></script>
        <script>
            var socket = io("http://localhost:9999/");
        </script>

    </body>
</html>
